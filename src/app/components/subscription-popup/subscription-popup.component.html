<div class="popup-overlay" *ngIf="isVisible" (click)="close()">
    <div class="popup-content" [ngClass]="{'webinar': activeFeature?.image_url && !submitted}"
        (click)="$event.stopPropagation()">
        <!-- Close Button -->
        <button class="close-btn" (click)="close()" aria-label="Close popup" title="Close">
            <i class="fas fa-times"></i>
        </button>

        <!-- Shared Registration Form Template -->
        <ng-template #formBlock>
            <!-- Loading State -->
            <div class="loading-state" *ngIf="isLoadingFeature">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading feature details...</p>
            </div>

            <!-- Error State -->
            <div class="error-state" *ngIf="featureLoadError && !isLoadingFeature">
                <i class="fas fa-exclamation-circle"></i>
                <p>{{ featureLoadError }}</p>
                <button class="btn-secondary" (click)="loadActiveFeature()">Retry</button>
            </div>

            <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" class="registration-form"
                *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                <!-- Error Message -->
                <div class="form-error" *ngIf="submitError">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>{{ submitError }}</span>
                </div>

                <!-- 2x2 Grid for first 4 inputs -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fullName">Full Name <span class="required">*</span></label>
                        <input id="fullName" type="text" formControlName="fullName" placeholder="Enter your full name"
                            [class.error]="fullName.invalid && (fullName.dirty || fullName.touched)">
                        <div class="error-message" *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">
                            <span *ngIf="fullName.errors?.['required']">Full name is required</span>
                            <span *ngIf="fullName.errors?.['minlength']">Name must be at least 3 characters</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber">Phone Number <span class="required">*</span></label>
                        <input id="phoneNumber" type="tel" formControlName="phoneNumber"
                            placeholder="Enter your phone number"
                            [class.error]="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)">
                        <div class="error-message"
                            *ngIf="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)">
                            <span *ngIf="phoneNumber.errors?.['required']">Phone number is required</span>
                            <span *ngIf="phoneNumber.errors?.['pattern']">Please enter a valid phone number (10-15
                                digits)</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">{{ activeFeature?.requires_linkedin ? 'Email to receive updates' : 'Email
                            Address' }} <span class="required">*</span></label>
                        <input id="email" type="email" formControlName="email"
                            [placeholder]="activeFeature?.requires_linkedin ? 'Enter your email address' : 'Enter your email address'"
                            [class.error]="email.invalid && (email.dirty || email.touched)">
                        <div class="error-message" *ngIf="email.invalid && (email.dirty || email.touched)">
                            <span *ngIf="email.errors?.['required']">Email is required</span>
                            <span *ngIf="email.errors?.['email']">Please enter a valid email address</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="companyName">Company Name <span class="required">*</span></label>
                        <input id="companyName" type="text" formControlName="companyName"
                            placeholder="Enter your company name"
                            [class.error]="companyName.invalid && (companyName.dirty || companyName.touched)">
                        <div class="error-message"
                            *ngIf="companyName.invalid && (companyName.dirty || companyName.touched)">
                            <span *ngIf="companyName.errors?.['required']">Company name is required</span>
                            <span *ngIf="companyName.errors?.['minlength']">Company name must be at least 2
                                characters</span>
                        </div>
                    </div>
                </div>

                <!-- Job Title + LinkedIn in one row if LinkedIn required -->
                <div class="form-grid" *ngIf="activeFeature?.requires_linkedin">
                    <div class="form-group">
                        <label for="jobPosition">Your Title/Role <span class="required">*</span></label>
                        <input id="jobPosition" type="text" formControlName="jobPosition"
                            placeholder="Enter your title or role"
                            [class.error]="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                        <div class="error-message"
                            *ngIf="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                            <span *ngIf="jobPosition.errors?.['required']">Job title is required</span>
                            <span *ngIf="jobPosition.errors?.['minlength']">Job title must be at least 2
                                characters</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="linkedinProfile">LinkedIn Profile Link <span class="required">*</span></label>
                        <input id="linkedinProfile" type="url" formControlName="linkedinProfile"
                            placeholder="https://www.linkedin.com/in/your-profile"
                            [class.error]="registrationForm.get('linkedinProfile')?.invalid && (registrationForm.get('linkedinProfile')?.dirty || registrationForm.get('linkedinProfile')?.touched)">
                        <div class="error-message"
                            *ngIf="registrationForm.get('linkedinProfile')?.invalid && (registrationForm.get('linkedinProfile')?.dirty || registrationForm.get('linkedinProfile')?.touched)">
                            <span *ngIf="registrationForm.get('linkedinProfile')?.errors?.['required']">LinkedIn profile
                                link is required</span>
                            <span *ngIf="registrationForm.get('linkedinProfile')?.errors?.['pattern']">Enter a valid
                                LinkedIn profile URL</span>
                        </div>
                    </div>
                </div>

                <!-- Full width for job title if LinkedIn not required -->
                <div class="form-group" *ngIf="!activeFeature?.requires_linkedin">
                    <label for="jobPosition">Your Title/Role <span class="required">*</span></label>
                    <input id="jobPosition" type="text" formControlName="jobPosition"
                        placeholder="Enter your title or role"
                        [class.error]="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                    <div class="error-message"
                        *ngIf="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                        <span *ngIf="jobPosition.errors?.['required']">Job title is required</span>
                        <span *ngIf="jobPosition.errors?.['minlength']">Job title must be at least 2 characters</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary" [disabled]="registrationForm.invalid || isSubmitting">
                    <span *ngIf="!isSubmitting">
                        {{ activeFeature?.button_text || 'Register Now' }}
                        <i class="fas fa-arrow-right"></i>
                    </span>
                    <span *ngIf="isSubmitting" class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        Submitting...
                    </span>
                </button>
            </form>
        </ng-template>

        <!-- Two-column layout when feature has image -->
        <div class="webinar-grid" *ngIf="activeFeature?.image_url && !submitted; else defaultContent">
            <div class="left-pane">
                <img [src]="activeFeature.image_url" [alt]="activeFeature.title" class="webinar-image" />
            </div>
            <div class="right-pane">
                <h2 class="popup-title">{{ activeFeature.title }}</h2>
                <div class="messages-container">
                    <p class="message-text">{{ activeFeature.description }}</p>
                </div>
                <ng-container *ngTemplateOutlet="formBlock"></ng-container>
            </div>
        </div>

        <!-- Default single-column layout (no image) -->
        <ng-template #defaultContent>
            <!-- Logo -->
            <div class="logo-container" *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                <img [src]="activeFeature?.image_url || '/public/icon-UFeed.png'" alt="UFeed" class="logo-image" />
            </div>

            <!-- Title -->
            <h2 class="popup-title" *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                {{ activeFeature?.title || 'Special Offer' }}
            </h2>

            <!-- Messages -->
            <div class="messages-container" *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                <p class="message-text">
                    {{ activeFeature?.description || 'Register now to take advantage of this special offer.' }}
                </p>
            </div>

            <ng-container *ngTemplateOutlet="formBlock"></ng-container>
        </ng-template>

        <!-- Success Message -->
        <div class="success-message" *ngIf="submitted">
            <div class="success-icon-wrapper">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>Registration Successful!</h3>
            <p class="success-description">
                {{ activeFeature?.title ? 'Thank you for registering for ' + activeFeature.title + '! ðŸŽ‰' : 'Thank you
                for registering! ðŸŽ‰' }}
            </p>
            <p class="success-info">
                Our team will review your application and contact you within <strong>24-48 hours</strong> with more
                details.
            </p>

            <div class="success-details">
                <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span>Check your email for confirmation</span>
                </div>
            </div>

            <div class="success-actions">
                <button class="btn-secondary" (click)="close()">
                    Close
                </button>
                <div class="auto-close-info" *ngIf="countdownInterval">
                    <i class="fas fa-clock"></i>
                    Auto-closing in {{ autoCloseTimer }}s
                    <button class="btn-link" (click)="cancelAutoClose()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>