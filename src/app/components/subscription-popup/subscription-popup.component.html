<div class="popup-overlay" *ngIf="isVisible" (click)="close()">
    <div class="popup-content" [ngClass]="{
        'webinar': activeFeature?.image_url && !submitted,
        'rtl': currentLang === 'ar'
        }"
        (click)="$event.stopPropagation()">
        <!-- Close Button -->
        <button class="close-btn" (click)="close()" aria-label="Close popup" title="Close">
            <i class="fas fa-times"></i>
        </button>

        <!-- Shared Registration Form Template -->
        <ng-template #formBlock>
            <!-- Loading State -->
            <div class="loading-state" *ngIf="isLoadingFeature">
                <i class="fas fa-spinner fa-spin"></i>
                <p>{{"subscription.popup.loading" | translate}}</p>
            </div>

            <!-- Error State -->
            <div class="error-state" *ngIf="featureLoadError && !isLoadingFeature">
                <i class="fas fa-exclamation-circle"></i>
                <p>{{ featureLoadError | translate}}</p>
                <button class="btn-secondary" (click)="loadActiveFeature()">{{"subscription.popup.retry" | translate}}</button>
            </div>

            <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" class="registration-form"
                *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                <!-- Error Message -->
                <div class="form-error" *ngIf="submitError">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>{{ submitError | translate}}</span>
                </div>

                <!-- 2x2 Grid for first 4 inputs -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fullName">{{"subscription.popup.form.name_label" | translate}}<span class="required">*</span></label>
                        <input id="fullName" type="text" formControlName="fullName" 
                        placeholder= "{{'subscription.popup.form.name_label'|translate}}" 
                            [class.error]="fullName.invalid && (fullName.dirty || fullName.touched)">
                        <div class="error-message" *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">
                            <span *ngIf="fullName.errors?.['required']">{{"subscription.popup.form.name_error" | translate}}</span>
                            <span *ngIf="fullName.errors?.['minlength']">{{"subscription.popup.form.name_error2" | translate}}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber">{{"subscription.popup.form.phone_label" | translate}}<span class="required">*</span></label>
                        <input id="phoneNumber" type="tel" formControlName="phoneNumber"
                            placeholder="{{'subscription.popup.form.phone_placeholder' | translate}}"
                            [class.error]="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)">
                        <div class="error-message"
                            *ngIf="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)">
                            <span *ngIf="phoneNumber.errors?.['required']">{{"subscription.popup.form.phone_error2" | translate}}</span>
                            <span *ngIf="phoneNumber.errors?.['pattern']">{{"subscription.popup.form.phone_error" | translate}}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">
                            {{"subscription.popup.form.email_label" | translate}}
                        <span class="required">*</span>
                        </label>

                        <input id="email" type="email" formControlName="email"
                            [placeholder]="'subscription.popup.form.email_placeholder' | translate"
                            [class.error]="email.invalid && (email.dirty || email.touched)">
                        <div class="error-message" *ngIf="email.invalid && (email.dirty || email.touched)">
                            <span *ngIf="email.errors?.['required']">{{"subscription.popup.form.email_error" | translate}}</span>
                            <span *ngIf="email.errors?.['email']">{{"subscription.popup.form.email_error2" | translate}}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="companyName">{{"subscription.popup.form.company_name_label" | translate}}<span class="required">*</span></label>
                        <input id="companyName" type="text" formControlName="companyName"
                            placeholder="{{'subscription.popup.form.company_name_placeholder' | translate}}"
                            [class.error]="companyName.invalid && (companyName.dirty || companyName.touched)">
                        <div class="error-message"
                            *ngIf="companyName.invalid && (companyName.dirty || companyName.touched)">
                            <span *ngIf="companyName.errors?.['required']">{{"subscription.popup.form.company_name_error" | translate}}</span>
                            <span *ngIf="companyName.errors?.['minlength']">{{"subscription.popup.form.company_name_error2" | translate}}</span>
                        </div>
                    </div>
                </div>

                <!-- Job Title + LinkedIn in one row if LinkedIn required -->
                <div class="form-grid" *ngIf="activeFeature?.requires_linkedin">
                    <div class="form-group">
                        <label for="jobPosition">{{"subscription.popup.form.title" | translate}}<span class="required">*</span></label>
                        <input id="jobPosition" type="text" formControlName="jobPosition"
                            placeholder="{{'subscription.popup.form.title.placeholder' | translate}}"
                            [class.error]="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                        <div class="error-message"
                            *ngIf="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                            <span *ngIf="jobPosition.errors?.['required']">{{"subscription.popup.form.title.error"|translate}}</span>
                            <span *ngIf="jobPosition.errors?.['minlength']">{{"subscription.popup.form.title.error" | translate}}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="linkedinProfile">{{"subscription.popup.form.linkedin" | translate}} <span class="required">*</span></label>
                        <input id="linkedinProfile" type="url" formControlName="linkedinProfile"
                            placeholder="https://www.linkedin.com/in/your-profile"
                            [class.error]="registrationForm.get('linkedinProfile')?.invalid && (registrationForm.get('linkedinProfile')?.dirty || registrationForm.get('linkedinProfile')?.touched)">
                        <div class="error-message"
                            *ngIf="registrationForm.get('linkedinProfile')?.invalid && (registrationForm.get('linkedinProfile')?.dirty || registrationForm.get('linkedinProfile')?.touched)">
                            <span *ngIf="registrationForm.get('linkedinProfile')?.errors?.['required']">{{"subscription.popup.form.linkedin.error"}}</span>
                            <span *ngIf="registrationForm.get('linkedinProfile')?.errors?.['pattern']">{{"subscription.popup.form.linkedin.error2"}}</span>
                        </div>
                    </div>
                </div>

                <!-- Full width for job title if LinkedIn not required -->
                <div class="form-group" *ngIf="!activeFeature?.requires_linkedin">
                    <label for="jobPosition">{{"subscription.popup.form.title" | translate}} <span class="required">*</span></label>
                    <input id="jobPosition" type="text" formControlName="jobPosition"
                        placeholder="{{'subscription.popup.form.title.placeholder' | translate}}"
                        [class.error]="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                    <div class="error-message"
                        *ngIf="jobPosition.invalid && (jobPosition.dirty || jobPosition.touched)">
                        <span *ngIf="jobPosition.errors?.['required']">{{"subscription.popup.form.title.error"|translate}}</span>
                        <span *ngIf="jobPosition.errors?.['minlength']">{{"subscription.popup.form.title.error2"|translate}}</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary" [disabled]="registrationForm.invalid || isSubmitting">
                    <span *ngIf="!isSubmitting">
                        {{ (currentLang === 'ar' ? activeFeature?.arButton_text : activeFeature?.button_text) || ('subscription.popup.form.submit' | translate) }}
                        <i class="fas fa-arrow-right"></i>
                    </span>
                    <span *ngIf="isSubmitting" class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        {{"subscription.popup.form.submitting" | translate}}
                    </span>
                    </button>

            </form>
        </ng-template>

        <!-- Two-column layout when feature has image -->
        <div class="webinar-grid" *ngIf="activeFeature?.image_url && !submitted; else defaultContent">
            <div class="left-pane">
                <img [src]="activeFeature.image_url" [alt]="activeFeature.title" class="webinar-image" />
            </div>
        <div class="right-pane">
        <h2 class="popup-title">
            {{ currentLang === 'ar' ? activeFeature.arTitle : activeFeature.title }}
        </h2>

        <div class="messages-container">
            <p class="message-text">
            {{ currentLang === 'ar' ? activeFeature.arDescription : activeFeature.description }}
            </p>
        </div>

        <ng-container *ngTemplateOutlet="formBlock"></ng-container>
        </div>
        </div>

        <!-- Default single-column layout (no image) -->
        <ng-template #defaultContent>
            <!-- Logo -->
            <div class="logo-container" *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                <img [src]="activeFeature?.image_url || '/public/icon-UFeed.png'" alt="UFeed" class="logo-image" />
            </div>

            <!-- Title -->
            <h2 class="popup-title" *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                {{ currentLang === 'ar' 
                    ? (activeFeature?.arTitle || 'ÿπÿ±ÿ∂ ÿÆÿßÿµ') 
                    : (activeFeature?.title || 'Special Offer') }}
            </h2>

            <!-- Messages -->
            <div class="messages-container" *ngIf="!submitted && !isLoadingFeature && !featureLoadError">
                <p class="message-text">
                {{ currentLang === 'ar' 
                    ? (activeFeature?.arDescription || 'ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿ¢ŸÜ ŸÑŸÑÿßÿ≥ÿ™ŸÅÿßÿØÿ© ŸÖŸÜ Ÿáÿ∞ÿß ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿßÿµ.') 
                    : (activeFeature?.description || 'Register now to take advantage of this special offer.') }}
                </p>
            </div>

        <ng-container *ngTemplateOutlet="formBlock"></ng-container>
</ng-template>

        <!-- Success Message -->
        <div class="success-message" *ngIf="submitted">
            <div class="success-icon-wrapper">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>{{"subscription.popup.form.successful" | translate}}</h3>
            <p class="success-description">
                {{ activeFeature?.title ? '{{"subscription.popup.form.success" | translate}}' + activeFeature.title + '! üéâ' : '{{"subscription.popup.form.success2" | translate}}' }}
            </p>
            <p class="success-info">
                {{"subscription.popup.form.success_msg_prefix" | translate}} 
                <strong>{{"subscription.popup.form.success_msg_hours" | translate}}</strong>
                 {{"subscription.popup.form.success_msg_sufix" | translate}}
            </p>

            <div class="success-details">
                <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span>{{"subscription.popup.form.confirmation" | translate}}</span>
                </div>
            </div>

            <div class="success-actions">
                <button class="btn-secondary" (click)="close()">
                    Close
                </button>
                <div class="auto-close-info" *ngIf="countdownInterval">
                    <i class="fas fa-clock"></i>
                    Auto-closing in {{ autoCloseTimer }}s
                    <button class="btn-link" (click)="cancelAutoClose()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>